# dla_cnn
This is a DLA finder based on a Convolutional neural network(CNN) deep learning model to classify, locate, and measure Dampened Lyman Alpha systems(DLAs) in DESI QSO spectra.
> paper link:

This code repository including code about training the CNN model and predicting DLAs in DESI QSO Spectra.

The pipeline for detecting DLAs in DESI spectra using our DLA Finder is shown below.

## Read Fits file and preprocess the sightlines

The first step is to read the Fits files you want to predict and preprocess spectra. Here we take DESI mock spectra: LondonMock v9.0 generated by the DESI Lyman $\alpha$ Forest Working Group in the `MOCK_spectra/desi-0.2-100/spectra-16` directory as an example.

If you want to use our trained model to predict the sightlinesï¼š

```
from dla.cnn.desi.get_sightline import get_sightlines
sightlines=get_sightlines(input='xxxx',output='xxxx')
```
This module use mock spectra in `input = 'MOCK_spectra/desi-0.2-100/spectra-16'` and produce a npy file  in `output = 'MOCK_spectra/processed/pre_sightlines.npy'`.

In this module, we iterate through all the fits files in the path, use the `desi/DesiMock` class to read spectra and perform pre-processing work such as rebinning, normalizing, and calculating the signal-to-noise ratio(S/N), then store the pre-processed spectra data into the `data_model/Sighline` class. Here lists the filters to spectra:

* spectra with z<2.33 are filtered
* spectra with S/N <1 are filtered
* only use the blue band in this sightline

Based on the dataset we want to generate, these filters can be changed.

PS: If you want to retrain the CNN model on your own, you may want to insert DLAs into sightlines. See `dla_cnn.desi.insert_dlas`, after preprocessing the sightlines, you can use the `insert_dlas` module to generate sightlines for training with NHI distribution you want. 

## Generate input datasets
The next step is to use preprocessed sightlines to generate datasets as input to the CNN model. The input to the model is a sliding window of the sightline. For sightlines with S/N > 3, we use `make_datasets` module:
```
from dla_cnn.desi.dataset import make_datasets
from dla_cnn.desi import defs
REST_RANGE = defs.REST_RANGE
kernel = defs.kernel
best_v = defs.best_v
sightlines=np.load('MOCK_spectra/processed/pre_sightlines.npy)
make_datasets(sightlines, kernel=kernel, REST_RANGE=REST_RANGE, v=best_v['all'],output='MOCK_spectra/processed/datasets.npy', validate=True)
```
The `kernel` sets the size of window, for S/N > 3, we set `defs.kernel=400`.  
The `REST_RANGE` represents the rest wavelength coverage when input to the CNN model, the default value is `defs.REST_RANGE=[900,1346]`
The `v` represents the velocity we choose to rebin the sightline. We calculated and saved in `desi/def.py` for different bands.

It is worth noting that spectra with different S/N using different processing codes. For sightlines with S/N > 3, we only split sightlines into samples and input one-dimensional flux array into the model trained with high S/N sightlines. While for sightlines with S/N<3, we use three median filters to smooth flux and input four-dimensional flux matrix into the model trained with low S/N sightlines.The datasets can be generated from `make_smoothdatasets`:
```
from dla_cnn.desi.dataset import make_datasets
from dla_cnn.desi import defs
REST_RANGE = defs.REST_RANGE
smooth_kernel= defs.smooth_kernel
best_v = defs.best_v
sightlines=np.load('MOCK_spectra/processed/pre_sightlines.npy)
make_smoothdatasets(sightlines,kernel=smooth_kernel, REST_RANGE=REST_RANGE, v=best_v['all'], output='MOCK_spectra/processed/datasets.npy', validate=True)
```
Using those two module you can produce a npy file  in `MOCK_spectra/processed/datasets.npy` for different S/N spectra.

PS: 
If you want to retrain the CNN model by your own, you can also use `make_datasets` to generate your training sets and test sets:
```
testnub=len(train_sightlines)//8
testingset=make_datasets(train_sightlines[0:testnub],kernel=kernel, REST_RANGE=REST_RANGE, v=best_v['all'],output='MOCK_spectra/processed/testingset.npy', validate=False)
trainingset=make_datasets(train_sightlines[testnub:-1],kernel=kernel, REST_RANGE=REST_RANGE, v=best_v['all'],output='MOCK_spectra/processed/trainingdatasets.npy', validate=False)
```
Same method for sightlines with S/N<3 to generate training sets and test sets. 

Then using the training set and test set to train the CNN model using `dla_cnn/training_model/training.py`
```
python training.py -i 1000000 -r 'traingset.npy' -e 'testset.npy' -c 'trainingmode/current' -t 600 -m 4
#1000000:training iterations
#600 4 :size of input data
#-c path to save the model file : ckpt format
#result : print training accuracy every 200 steps , print test accuracy every 5000 steps (classification accuracy)
```
This module will save the model file in the `trainingmode/current` directory.

## Predictions for windows

The third step is to get predictions for the input datasets using CNN model corresponding to the S/N.
```
python dla_cnn/training_model/get_partpredicition.py
```
The input spectra file is located in line 182, and line 185 lists the ckpt model file we saved during training.

This module will produce a npy file in the `MOCK_spectra/processed` directory containing pred, conf, offset, and col_density arrays for every window. These data will be used to get whole sightline predictions next.

## Prediction for sightlines

The last step is to transfer the prediction for windows into the prediction for the sightlines.
We set the parameter about confidence level 1 and confidence level 2
`level1=0.5
level2=0.2`
if the confidence level > 0.5, the pred for the window will be 1, if the offset peak of this pixel point > 0.2, there will be a DLA in this pixel.
```
from dla_cnn.desi.pred_sightline import get_results,save_pred
from dla_cnn.desi.dla_catalog import catalog_fits
#get absorber list for each sightline
pred_catalog=save_pred(sightlines,preds,level2,level1,filename='Mock_spectra/processed/pred_dla_catalog.fits')
#compare prediction with real absorbers,generate NHI,z hist and calculate confusion matrix
real_catalog=catalog_fits(sightlines,dlafile='Mock_spectra/processed/real_dla_catalog.fits',qsofile='Mock_spectra/processed/qso_catalog.fits')
get_results(real_catalog,pred_catalog,realname='Mock_spectra/processed/real_label_dla_catalog.fits',predname='Mock_spectra/processed/pred_label_dla_catalog.fits',path='Mock_spectra/processed')
```
The `save_pred` module will generate a Fits file about the absorbers catalog for each sightline in the `MOCK_spectra/processed` directory.
The `catalog_fits` module will generate the QSO catalog and real DLA catalog(using MOCK) in the `MOCK_spectra/processed` directory.
The `get_results` module is used to validate our model, we can compare the predictions with real absorbers (If we have the real absorber catalog), then generate the $\Delta z$ and $\Delta log(N_{HI})$ histogram and adding information about true positive, false negative, false positive to those two DLA catalogs.

Copyright (c) [2021] [Jiaqi Zou - zoujq20@mails.tsinghua.edu.cn]
